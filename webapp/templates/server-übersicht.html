<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Steuerung</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0d2b47 0%, #1a4b72 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            background: rgba(255, 255, 255, 0.08);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            margin-top: 30px;
        }
        
        .server-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .server-header h2 {
            font-size: 2.2rem;
            color: #4fc3f7;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(79, 195, 247, 0.5);
        }

        .navigation a {
            color: #4fc3f7;      /* Standardfarbe */
            text-decoration: none; /* optional: Unterstreichung entfernen */
        }

        .navigation a:visited {
            color: #4fc3f7;      /* gleiche Farbe auch f√ºr besuchte Links */
        }

        .navigation a:hover {
            color: #0288d1;      /* helleres Blau beim Hover */
        }

        .navigation a:active {
            color: #01579b;      /* dunkler beim Klicken */
        }
        
        .server-header p {
            font-size: 1.1rem;
            opacity: 0.8;
        }
        
        .status-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            width: 300px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-card h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #bbdefb;
        }
        
        .status-indicator {
            font-size: 1.4rem;
            font-weight: bold;
            padding: 12px 20px;
            border-radius: 50px;
            display: inline-block;
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .status-running {
            background: linear-gradient(135deg, #00c853, #64dd17);
            color: white;
        }
        
        .status-stopped {
            background: linear-gradient(135deg, #f44336, #ff5252);
            color: white;
        }
        
        .status-starting {
            background: linear-gradient(135deg, #ffab00, #ffd600);
            color: white;
        }
        
        .status-unhealthy {
            background: linear-gradient(135deg, #ff6d00, #ffab40);
            color: white;
        }
        
        .status-error {
            background: linear-gradient(135deg, #aa00ff, #e254ff);
            color: white;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }
        
        .action-btn {
            padding: 16px 32px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 140px;
        }
        
        .start-btn {
            background: linear-gradient(135deg, #00c853, #64dd17);
            color: white;
        }
        
        .stop-btn {
            background: linear-gradient(135deg, #f44336, #ff5252);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .action-btn:active {
            transform: translateY(1px);
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        #message {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.5s ease;
            max-height: 0;
            overflow: hidden;
        }

        .message-visible {
            opacity: 1 !important;
            max-height: 100px !important;
        }

        .message-hidden {
            opacity: 0 !important;
            max-height: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        .message-success {
            background: rgba(0, 200, 83, 0.2);
            border: 1px solid #00c853;
        }

        .message-error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
        }

        .message-info {
            background: rgba(3, 169, 244, 0.2);
            border: 1px solid #03a9f4;
        }
        
        /* Log-Anzeige Styles */
        .log-section {
            margin-top: 40px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .log-header h3 {
            color: #bbdefb;
            font-size: 1.3rem;
        }
        
        .log-controls {
            display: flex;
            gap: 10px;
        }
        
        .log-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .log-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-time {
            color: #4fc3f7;
            font-weight: bold;
        }
        
        .log-message {
            color: #e3f2fd;
        }
        
        .log-error {
            color: #ff5252;
        }
        
        .log-success {
            color: #69f0ae;
        }
        
        .log-warning {
            color: #ffab40;
        }
        
        .refresh-animation {
            animation: rotate 1s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 600px) {
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .action-btn {
                width: 100%;
                max-width: 250px;
            }
            
            .container {
                padding: 20px;
            }
            
            .log-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .log-controls {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="navigation">
        <a href="{{ url_for('home') }}" class="home-link">
            <span>‚Üê Zur√ºck zur √úbersicht</span>
        </a>
    </div>
    <div class="container">
        <div class="server-header">
            <h2>Server Steuerung</h2>
            <p>Verwalten Sie Ihren Container: {{ container_name }}</p>
        </div>
        
        <div class="status-container">
            <div class="status-card">
                <h3>Aktueller Status</h3>
                <div class="status-indicator status-{{ container_status }}">
                    {{ container_status }}
                </div>
            </div>
        </div>
        
        <!-- Nachrichtenzeile -->
        <div id="message" class="message-hidden"></div>
        
        <div class="action-buttons">
            <form action="/start-container/{{ container_name }}" method="post">
                <button type="submit" class="action-btn start-btn">Starten</button>
            </form>
            
            <form action="/stop-container/{{ container_name }}" method="post">
                <button type="submit" class="action-btn stop-btn">Stoppen</button>
            </form>
        </div>
        
        <!-- Log-Anzeige -->
        <div class="log-section">
            <div class="log-header">
                <h3>Log-Eintr√§ge</h3>
                <div class="log-controls">
                    <button class="log-btn" onclick="refreshLogs()" id="refresh-btn">
                        üîÑ Aktualisieren
                    </button>
                    <button class="log-btn" onclick="clearLogs()">
                        üóëÔ∏è Leeren
                    </button>
                </div>
            </div>
            
            <div class="log-container" id="log-container">
                <div class="log-entry">
                    <span class="log-time">Lade Logs...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Statusfarben mapping
        const statusColors = {
            'running': 'status-running',
            'stopped': 'status-stopped',
            'exited': 'status-stopped',
            'starting': 'status-starting',
            'unhealthy': 'status-unhealthy',
            'error': 'status-error'
        };
        
        // Funktion zum Anzeigen von Nachrichten
        // Funktion zum Anzeigen von Nachrichten
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            
            // Entferne alle Nachrichtenklassen
            messageEl.classList.remove('message-success', 'message-error', 'message-info', 'message-visible', 'message-hidden');
            
            // F√ºge die entsprechende Nachrichtenklasse hinzu
            messageEl.classList.add(type);
            messageEl.classList.add('message-visible');
            
            // Nachricht nach 3 Sekunden ausblenden
            setTimeout(() => {
                hideMessage();
            }, 3000);
        }

        // Funktion zum Ausblenden der Nachricht
        function hideMessage() {
            const messageEl = document.getElementById('message');
            messageEl.classList.remove('message-visible');
            messageEl.classList.add('message-hidden');
        }
        
        // Funktion zum Aktualisieren des Status
        function updateStatus(status) {
            const statusIndicator = document.querySelector('.status-indicator');
            statusIndicator.textContent = status;
            
            // Entferne alle Status-Klassen
            statusIndicator.classList.remove(...Object.values(statusColors));
            
            // F√ºge die entsprechende Status-Klasse hinzu
            if (statusColors[status]) {
                statusIndicator.classList.add(statusColors[status]);
            } else {
                statusIndicator.classList.add('status-error');
            }
            
            // Button-Zust√§nde aktualisieren
            updateButtonStates(status);
        }
        
        // Funktion zum Aktualisieren der Button-Zust√§nde
        function updateButtonStates(status) {
            const startBtn = document.querySelector('.start-btn');
            const stopBtn = document.querySelector('.stop-btn');
            
            if (status === 'running') {
                startBtn.disabled = true;
                stopBtn.disabled = false;
            } else if (status === 'stopped' || status === 'exited') {
                startBtn.disabled = false;
                stopBtn.disabled = true;
            } else {
                // F√ºr andere Status wie 'starting', 'unhealthy', etc.
                startBtn.disabled = true;
                stopBtn.disabled = true;
            }
        }
        
        // Funktion zum Abrufen und Anzeigen der Logs
        function fetchLogs() {
            const logContainer = document.getElementById('log-container');
            const refreshBtn = document.getElementById('refresh-btn');
            
            // Animation starten
            refreshBtn.classList.add('refresh-animation');
            
            fetch(`/get-logs/{{ container_name }}`)
                .then(response => response.json())
                .then(data => {
                    if (data.logs && data.logs.length > 0) {
                        logContainer.innerHTML = '';
                        
                        data.logs.forEach(logEntry => {
                            const entryDiv = document.createElement('div');
                            entryDiv.className = 'log-entry';
                            
                            // Log-Eintrag parsen (Zeitstempel und Nachricht)
                            const logParts = logEntry.split(' - ');
                            let timePart = '';
                            let messagePart = logEntry;
                            
                            if (logParts.length >= 2) {
                                timePart = logParts[0];
                                messagePart = logParts.slice(1).join(' - ');
                            }
                            
                            // Bestimme die Log-Klasse basierend auf dem Inhalt
                            let logClass = 'log-message';
                            if (messagePart.includes('FEHLER') || messagePart.includes('Error') || 
                                messagePart.includes('error') || messagePart.includes('failed')) {
                                logClass = 'log-error';
                            } else if (messagePart.includes('erfolg') || messagePart.includes('success') || 
                                    messagePart.includes('gestartet') || messagePart.includes('completed')) {
                                logClass = 'log-success';
                            } else if (messagePart.includes('Warnung') || messagePart.includes('warning') || 
                                    messagePart.includes('WARNING')) {
                                logClass = 'log-warning';
                            }
                            
                            entryDiv.innerHTML = `
                                <span class="log-time">${timePart}</span> - 
                                <span class="${logClass}">${messagePart}</span>
                            `;
                            
                            logContainer.appendChild(entryDiv);
                        });
                        
                        // Scroll zum Ende der Logs
                        logContainer.scrollTop = logContainer.scrollHeight;
                    } else {
                        logContainer.innerHTML = '<div class="log-entry">Keine Log-Eintr√§ge f√ºr diesen Container vorhanden</div>';
                    }
                    
                    // Animation stoppen
                    refreshBtn.classList.remove('refresh-animation');
                })
                .catch(error => {
                    logContainer.innerHTML = '<div class="log-entry log-error">Fehler beim Laden der Logs</div>';
                    console.error('Fehler beim Abrufen der Logs:', error);
                    refreshBtn.classList.remove('refresh-animation');
                });
        }

        // Funktion zum Leeren der Logs (Server-seitig)
        function clearLogs() {
            if (confirm('M√∂chten Sie wirklich alle Logs f√ºr diesen Container l√∂schen?')) {
                fetch('/clear-logs/{{ container_name }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage(data.message, 'message-success');
                        fetchLogs(); // Logs neu laden (werden jetzt leer sein)
                    } else {
                        showMessage(data.message, 'message-error');
                    }
                })
                .catch(error => {
                    showMessage('Fehler beim L√∂schen der Logs', 'message-error');
                    console.error('Fehler beim L√∂schen der Logs:', error);
                });
            }
        }
        
        // Funktion zum Aktualisieren der Logs
        function refreshLogs() {
            fetchLogs();
            showMessage('Logs aktualisiert', 'message-info');
        }
        
        // Funktion zum Leeren der Logs (lokal im Browser)
        function clearLogs() {
            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML = '<div class="log-entry">Logs geleert</div>';
            showMessage('Log-Anzeige geleert', 'message-info');
        }
        
        // Event-Listener f√ºr Formulare (AJAX)
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('form');
            
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const action = this.getAttribute('action');
                    const button = this.querySelector('button');
                    const originalText = button.textContent;
                    
                    // Button w√§hrend der Anfrage deaktivieren
                    button.disabled = true;
                    button.textContent = 'Wird ausgef√ºhrt...';
                    
                    fetch(action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            showMessage('Aktion erfolgreich ausgef√ºhrt!', 'message-success');
                            
                            // Status und Logs nach einer kurzen Pause erneut abrufen
                            setTimeout(() => {
                                checkServerStatus();
                                fetchLogs();
                                button.textContent = originalText;
                            }, 2000);
                        } else {
                            throw new Error('Aktion fehlgeschlagen');
                        }
                    })
                    .catch(error => {
                        showMessage('Fehler bei der Ausf√ºhrung: ' + error.message, 'message-error');
                        button.disabled = false;
                        button.textContent = originalText;
                    });
                });
            });
            
            // Initialen Status setzen
            updateButtonStates('{{ container_status }}');
            
            // Logs beim Laden der Seite abrufen
            fetchLogs();
        });
        
        // Funktion zum Abrufen des Serverstatus (alle 10 Sekunden)
        function checkServerStatus() {
            fetch('/server-status/{{ container_name }}')
                .then(response => response.json())
                .then(data => {
                    updateStatus(data.status);
                })
                .catch(error => {
                    console.error('Fehler beim Abrufen des Status:', error);
                });
        }
        
        // Status regelm√§√üig aktualisieren
        setInterval(checkServerStatus, 10000);
        
        // Logs alle 30 Sekunden aktualisieren
        setInterval(fetchLogs, 30000);
    </script>
</body>
</html>